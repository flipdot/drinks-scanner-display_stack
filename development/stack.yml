version: "3.7"
services:
  adminer:
    deploy:
      labels:
      - traefik.enable=true
      - traefik.http.routers.adminer.middlewares=redirectscheme
      - traefik.http.routers.adminer.rule=Host(`adminer.${STACK_DOMAIN}`, `adminer.${STACK_DOMAIN_LOCAL}`)
      - traefik.http.routers.adminer_secure.rule=Host(`adminer.${STACK_DOMAIN}`, `adminer.${STACK_DOMAIN_LOCAL}`)
      - traefik.http.routers.adminer_secure.tls.options=mintls13@file #DARGSTACK-REMOVE
      - traefik.http.services.adminer.loadbalancer.server.port=8080
    image: "adminer:4@sha256:639cedba6256367b13212a155c0f09cfdaadebebe3528eb0bb61850802f62448"
  drinks-touch:
    deploy:
      labels:
      - traefik.enable=true
      - traefik.http.routers.drinks-touch.middlewares=redirectscheme
      - traefik.http.routers.drinks-touch.rule=Host(`${STACK_DOMAIN}`, `${STACK_DOMAIN_LOCAL}`, `www.${STACK_DOMAIN}`, `www.${STACK_DOMAIN_LOCAL}`)
      - traefik.http.routers.drinks-touch_secure.rule=Host(`${STACK_DOMAIN}`, `${STACK_DOMAIN_LOCAL}`, `www.${STACK_DOMAIN}`, `www.${STACK_DOMAIN_LOCAL}`)
      - traefik.http.routers.drinks-touch_secure.tls.options=mintls13@file #DARGSTACK-REMOVE
      - traefik.http.services.drinks-touch.loadbalancer.server.port=80
    environment:
      DISPLAY: "unix${DISPLAY}"
    image: "flipdot/drinks-touch:dev"
    volumes:
    - "../../drinks-touch/drinks_touch/:/app/"
    - "/tmp/.X11-unix:/tmp/.X11-unix"
  ldap:
    image: "osixia/openldap@sha256:eaefde9d33b03fe04d081767fda7d3c3500ec861108bbdd19c1b5ceb76e3ee27"
    environment:
      LDAP_DOMAIN: "flipdot.org"
      LDAP_LOGIN_DN: "dc=flipdot,dc=org"
      LDAP_ADMIN_PASSWORD: "admin"
    ports:
    - "389:389"
    - "639:639"
  phpldapadmin:
    deploy:
      labels:
      - traefik.enable=true
      - traefik.http.routers.phpldapadmin.middlewares=redirectscheme
      - traefik.http.routers.phpldapadmin.rule=Host(`phpldapadmin.${STACK_DOMAIN}`, `phpldapadmin.${STACK_DOMAIN_LOCAL}`)
      - traefik.http.routers.phpldapadmin_secure.rule=Host(`phpldapadmin.${STACK_DOMAIN}`, `phpldapadmin.${STACK_DOMAIN_LOCAL}`)
      - traefik.http.routers.phpldapadmin_secure.tls.options=mintls13@file #DARGSTACK-REMOVE
      - traefik.http.services.phpldapadmin.loadbalancer.server.port=80
    environment:
      PHPLDAPADMIN_HTTPS: "false"
    image: "osixia/phpldapadmin:0.9.0@sha256:0b1e0ac15fff82dc5fdf12be6de06f91dc97f5fc95df5a29422a4b168dd818a6"
    volumes:
    - "phpldapadmin-data:/var/www/phpldapadmin"
  postgres:
    image: "postgres:12.0-alpine@sha256:55ce4ed5ea366bfe9bd141b85608eb62a9f26f524ce0d095fb4c0a3ee50228cd"
    environment:
      POSTGRES_DB: "drinks"
      POSTGRES_PASSWORD: "postgres"
    volumes:
    - "postgres-data:/var/lib/postgresql/data"
    - "../production/data/postgres/01-schema.sql:/docker-entrypoint-initdb.d/01-schema.sql"
    - "../production/data/postgres/02-drinks.sql:/docker-entrypoint-initdb.d/02-drinks.sql"
  traefik:
    command:
      - --api=true
      - --entryPoints.web.address=:80
      - --entryPoints.web-secure.address=:443
      - --providers.docker=true
      - --providers.docker.endpoint=unix:///var/run/docker.sock
      - --providers.docker.exposedByDefault=false
      - --providers.docker.swarmMode=true
      - --providers.file.filename=/dynamic.yml #DARGSTACK-REMOVE
      - --providers.file.watch=true #DARGSTACK-REMOVE
    deploy:
      labels:
      - traefik.enable=true
      - traefik.http.middlewares.redirectscheme.redirectscheme.scheme=https
      - traefik.http.routers.traefik.middlewares=redirectscheme
      - traefik.http.routers.traefik.rule=Host(`traefik.${STACK_DOMAIN}`)
      - traefik.http.routers.traefik_secure.rule=Host(`traefik.${STACK_DOMAIN}`)
      - traefik.http.routers.traefik_secure.service=api@internal
      - traefik.http.routers.traefik_secure.tls.options=mintls13@file #DARGSTACK-REMOVE
      - traefik.http.services.traefik.loadbalancer.server.port=8080
      mode: global
      placement:
        constraints:
        - node.role == manager
    image: traefik:v2.0.5@sha256:671d29600a66bbb28bfffc3755878a30c5d89d1186c7ded1878b902ba95068c6
    ports:
    - mode: host
      protocol: tcp
      published: 80
      target: 80
    - mode: host
      protocol: tcp
      published: 443
      target: 443
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - ./certificates/:/etc/traefik/acme/
    - ./configurations/traefik/dynamic.yml:/dynamic.yml:ro #DARGSTACK-REMOVE
volumes:
  phpldapadmin-data: {}
  postgres-data: {}
